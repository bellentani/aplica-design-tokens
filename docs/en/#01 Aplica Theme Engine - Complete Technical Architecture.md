# Aplica Theme Engine - Complete Technical Architecture

## ğŸ“‹ Overview

The **Aplica Theme Engine** is a multidimensional Design Tokens architecture that enables scalable creation and management of visual themes through hierarchical transformations. The architecture supports multiple brands, visual modes, and surface contexts, generating final themes programmatically.

## ğŸ—ï¸ 5-Layer Architecture

### **Single Source of Truth (SSoT)**
```
Git Repository (JSON files)
â”œâ”€â”€ brand/theme/
â”‚   â”œâ”€â”€ tangerine/
â”‚   â”‚   â”œâ”€â”€ _brand.json
â”‚   â”‚   â”œâ”€â”€ _grayscale.json
â”‚   â”‚   â”œâ”€â”€ _theme-typography.json
â”‚   â”‚   â”œâ”€â”€ _theme-borders.json
â”‚   â”‚   â”œâ”€â”€ _theme-depth.json
â”‚   â”‚   â”œâ”€â”€ _components.json
â”‚   â”‚   â””â”€â”€ _tangerine-generated.json
â”‚   â”œâ”€â”€ joy/
â”‚   â”‚   â”œâ”€â”€ _brand.json
â”‚   â”‚   â”œâ”€â”€ _grayscale.json
â”‚   â”‚   â”œâ”€â”€ _theme-typography.json
â”‚   â”‚   â”œâ”€â”€ _theme-borders.json
â”‚   â”‚   â”œâ”€â”€ _theme-depth.json
â”‚   â”‚   â”œâ”€â”€ _components.json
â”‚   â”‚   â”œâ”€â”€ _primitive-theme-default.json
â”‚   â”‚   â””â”€â”€ _primitive-theme-default-config.json
â”‚   â””â”€â”€ grinch/
â”‚       â”œâ”€â”€ _brand.json
â”‚       â”œâ”€â”€ _grayscale.json
â”‚       â”œâ”€â”€ _theme-typography.json
â”‚       â”œâ”€â”€ _theme-borders.json
â”‚       â”œâ”€â”€ _theme-depth.json
â”‚       â”œâ”€â”€ _components.json
â”‚       â””â”€â”€ _grinch-generated.json
â”œâ”€â”€ dimensions/
â”‚   â””â”€â”€ dimension.json
â”œâ”€â”€ mode/
â”‚   â”œâ”€â”€ light.json
â”‚   â””â”€â”€ dark.json
â”œâ”€â”€ surface/
â”‚   â”œâ”€â”€ positive.json
â”‚   â””â”€â”€ negative.json
â”œâ”€â”€ semantic/
â”‚   â””â”€â”€ default.json
â”œâ”€â”€ foundation/
â”‚   â”œâ”€â”€ default.json
â”‚   â””â”€â”€ styles/
â”‚       â”œâ”€â”€ typography-styles.json
â”‚       â””â”€â”€ depth-styles.json
â”œâ”€â”€ figma-generators/
â”‚   â””â”€â”€ _generator-dimension.json
â”œâ”€â”€ $themes.json
â””â”€â”€ $metadata.json
```

**Note about underscore (_) files:**
- They are structural and indicative tokens
- They don't belong to the main transformation chain
- They facilitate theme set organization in Tokens Studio
- Ex: `_primitive-theme-default.json` is generated by accessibility API

---

## ğŸ”„ Transformation Flow

### **Main Flow**
```
Brand Theme â†’ Mode â†’ Surface â†’ Semantic â†’ Foundation
```

### **Dimensional Flow** 
```
Dimensions â†’ Semantic â†’ Foundation
```

### **Component Flow**
```
Semantic â†’ Components (direct)
```

---

## ğŸ“Š Detailed Layers

### **1. CORE - Backbone**

#### **Brand Theme**
- **Responsibility:** Defines specific visual aspects of each brand/theme
- **Location:** `brand/theme/[brand]/`
- **Current Brands:**
  - **joy:** Brand that uses Tokens Studio with native mathematics and calculations
  - **tangerine:** Brand that uses our token generation API
  - **grinch:** Brand that uses our token generation API
- **Content:** Color palettes, typography, theme visual elements

##### **Object Structure:**

**`theme.light` vs `theme.dark`:**
- **Purpose:** Generate light and dark modes with specific colors
- **Differentiation:** Colors may look similar but are different
- **Dark Mode:** Saturation adjusted for context change
- **Result:** Each mode has palette optimized for its visual context

**`brand.branding` (first, second, third):**
- **Category:** Direct brand colors that impact UI "temperature"
- **Hierarchy:** Ordinal naming (first, second, third, fourth...)
- **Origin:** Based on brand guide and available colors
- **Usage:** Colors that convey brand feeling in semantic/foundation layers
- **Structure:** Each ordinal has intensity variations:
  - **`lowest`:** Lightest possible value within context
  - **`default`:** Brand default color
  - **`highest`:** Darkest possible value
- **Example:** For orange brand
  - `lowest`: very light orange (#FFF3E0)
  - `default`: standard orange (#FF9800) 
  - `highest`: dark orange (#E65100)

**`brand.ambient`:**
- **Purpose:** Structures that create platform shadows and lights
- **`contrast`:** Defines interface base colors
  - **`base`:** Colors close to black and white (but not absolute)
    - `positive`: lighter colors (light base)
    - `negative`: darker colors (dark base)
  - **`deep`:** Absolute black (#000000) and white (#ffffff)
    - `positive`: always white
    - `negative`: always black
  - **Semantics:** Maintains layer logic even at extremes
- **`neutral`:** Neutral colors for backgrounds and interface design
  - Usually decomposition of primary color (first)
  - Dependent on specific design
  - **Expanded Scale:** 7 variations for greater granularity
    - `lowest` (lightest) â†’ `lower` â†’ `low` â†’ `mid` â†’ `high` â†’ `higher` â†’ `highest` (darkest)
  - **Usage:** Shadows, design tones, backgrounds with subtleties
- **`grayscale`:** Standard gray scale
  - **Expanded Scale:** 7 variations for maximum flexibility
    - `lowest` (lightest) â†’ `lower` â†’ `low` â†’ `mid` â†’ `high` â†’ `higher` â†’ `highest` (darkest)
  - **Usage:** Gray system for interfaces, texts, borders, dividers

**`interface`:**
- **Purpose:** Colors for UI interactions with specific semantics
- **Differentiation:** Don't necessarily follow brand colors
  - Ex: Orange brand can have black primary button
- **`function`:** Interface hierarchy and links
- **`feedback`:** Standard system feedback colors (success, warning, danger, info)

**`product`:**
- **Purpose:** Product-related semantic colors
- **Examples:** `cold`, `promo`, `flash`, etc.
- **Variability:** Depends on product type (some interfaces don't use)
- **Context:** Product domain-specific semantics

**`text`:**
- **Purpose:** Text color structures
- **Concepts:** Already works with positive/negative internally
- **Application:** Base for typographic hierarchy

```json
{
  "theme": {
    "light": {
      "brand": {
        "branding": {
          "first": { "lowest": {}, "default": {}, "highest": {} },
          "second": { "lowest": {}, "default": {}, "highest": {} },
          "third": { "lowest": {}, "default": {}, "highest": {} }
        },
        "ambient": {
          "contrast": { "base": {}, "deep": {} },
          "neutral": { "lowest": {}, "lower": {}, "low": {}, "mid": {}, "high": {}, "higher": {}, "highest": {} },
          "grayscale": { "lowest": {}, "lower": {}, "low": {}, "mid": {}, "high": {}, "higher": {}, "highest": {} }
        }
      },
      "interface": {
        "function": { "primary": {}, "secondary": {}, "link": {} },
        "feedback": { "info": {}, "success": {}, "warning": {}, "danger": {} }
      },
      "product": {
        "cold": { "lowest": {}, "default": {}, "highest": {} }
      },
      "text": {
        "positive": {}, "negative": {}
      }
    }
  }
}
```

**Advanced Customization:** 
- Brands using our API can "break" `_primitive-theme` when necessary
- Allows specific values that don't follow standard decomposition
- Used in evolved brands with specific customizations
- **Critical Restriction:** Surface accessibility vs txtOn must always be maintained
- **Joy (Tokens Studio):** Uses native Tokens Studio mathematics for accessibility calculations

#### **Dimensions**
- **Responsibility:** Defines dimensional values (spacing, sizing, typography)
- **File:** `dimensions/dimension.json`
- **Flow:** Directly impacts Semantic (bypasses Mode/Surface)
- **Context:** "normal" allows future variations (compact, spacious)

##### **Object Structure:**

**`_theme_dimensions`:**
- **Purpose:** Size scale with standard mathematical formula
- **Base:** Adapted Fibonacci Progression
- **Units:**
  - **Layout Unit:** 1un = 4px
  - **Standard Unit:** 1ud = 16px
- **Current Scale:**
  ```
  zero: 0
  pico: 1
  nano: 2
  micro: 4
  extraSmall: 8
  small: 12
  medium: 16 (base)
  large: 20
  extraLarge: 24
  mega: 28
  giga: 44
  tera: 72
  peta: 116
  ```

**`_theme_typography`:**
- **`fontSizes`:**
  - **Base Unit:** medium = 16px (always the standard unit)
  - **Scale:** Based on Adapted Fibonacci Progression
  - **Values:** 10, 12, 14, 16, 20, 24, 28, 36, 40, 48, 60
  
- **`lineHeights`:**
  - **Variations:** tight (100%), close (120%), regular (140%), wild (180%)
  - **Formula:** `ROUNDUP(fontSize Ã— multiplier / 4) Ã— 4`
  - **Guarantee:** All values are multiples of 4px
  - **Example:** 14px Ã— 1.2 = 16.8px â†’ rounded to 20px

**Future Density:**
- **Current:** Only `normal` due to DS maturity
- **Future:** `compact`, `spacious` with different scales
- **Flexibility:** System prepared for multiple densities

### **2. MODE - Visual Contexts**

- **Responsibility:** Defines visual contexts (light/dark) determining how colors behave
- **Files:** `mode/light.json`, `mode/dark.json`
- **Function:** Allows switching between light and dark themes

#### **Structure and Transformations:**

**Hierarchy Preservation:**
```json
// Brand
"theme.light.brand.branding.first.default.background"

// Mode (light.json)
"mode.brand.branding.first.default.background": {
  "$value": "{theme.light.brand.branding.first.default.background}"
}
```

**Interface States (MODE exclusive):**
- **States:** `negative`, `action`, `normal`, `active`, `positive`
- **Applied to:** `surface`, `txtOn`, `border`
- **Reason:** Brand colors are static, interface colors have behavior

**Text Layer:**
- **Hierarchy:** `title`, `body`, `highlight`, `muted`, `label`
- **Feedback:** `info`, `success`, `warning`, `danger`
- **Concept:** `positive/negative` refers to surface context

### **3. SURFACE - Photographic Logic**

- **Responsibility:** Applies visual hierarchy concept inspired by photography
- **Files:** `surface/positive.json`, `surface/negative.json`
- **Central Concept:** Photography analogy
  - **Positive:** Like a positive photographic film (normal colors)
  - **Negative:** Like a photographic negative (inverted colors)

#### **Inversion Logic:**

**For Intensities (lowest/default/highest):**
```
POSITIVE â†’ NEGATIVE:
- lowest â†’ highest (lightest becomes darkest)
- default â†’ default (maintains)
- highest â†’ lowest (darkest becomes lightest)
```

**For 7-level scales (neutral/grayscale):**
```
POSITIVE â†’ NEGATIVE:
- lowest â†’ highest
- lower â†’ higher
- low â†’ high
- mid â†’ mid (maintains)
- high â†’ low
- higher â†’ lower
- highest â†’ lowest
```

#### **Special Transformations:**

**1. Contrast (base/deep):**
- **Positive Surface:**
  - `base.light` â†’ references `mode...positive`
  - `base.dark` â†’ references `mode...negative`
- **Negative Surface:** 
  - `base.light` â†’ references `mode...negative` (inverts)
  - `base.dark` â†’ references `mode...positive` (inverts)

**2. Interface States:**
- Maintains states but inverts `positive/negative` in MODE
- States: `normal`, `action`, `active`
- Adds `main/secondary` structure for feedback

**3. Text Layer:**
- **Positive:** uses `mode.text.positive.*`
- **Negative:** uses `mode.text.negative.*`

#### **New Structure: Opacity**
Surface adds opacity system with hardcoded hexadecimal values:
```json
"opacity": {
  "color": {
    "dark": { // dark colors with transparency
      "transparent": "#33333300",     // 0% opacity
      "superTransparent": "#3333331a", // 10% opacity
      "semiTranslucid": "#33333333",  // 20% opacity
      "translucid": "#33333380",      // 50% opacity
      "superTranslucid": "#333333cc", // 80% opacity
      "semiOpaque": "#333333e6",      // 90% opacity
      "opaque": "#333333"             // 100% opacity
    },
    "light": { // light colors with transparency
      // same structure but with #ffffff
    }
  }
}
```

**Note:** In positive.json, `opacity.dark` uses black, `opacity.light` uses white. In negative.json, it inverts.

### **4. SEMANTIC - Final Consolidation**

- **Responsibility:** Consolidates all previous transformations into a unified theme with specific purpose
- **File:** `semantic/default.json`
- **Purpose:** Create the final interface that will be consumed by Foundation and Components

#### **Central Concept:**
SEMANTIC is where colors gain **interface purpose**. It's the final result of all transformations (Brand Theme â†’ Mode â†’ Surface) consolidated into a unique and coherent structure that will be distributed to upper layers.

#### **Complete Semantic Structure:**

**1. Color - Complete color system:**
```json
"semantic": {
  "color": {
    "brand": { // theme colors with purpose
      "branding": { first, second, third },
      "ambient": { contrast, neutral, grayscale }
    },
    "interface": { // functional UI colors
      "function": { primary, secondary, link, disabled },
      "feedback": { info, success, warning, danger }
    },
    "text": { // simplified text colors
      title, body, highlight, muted, label,
      info, success, warning, danger, rewards, cold
    },
    "product": { // specific product colors
      cold: { lowest, default, highest }
    }
  }
}
```

**2. Opacity - Transparency system:**
```json
"opacity": {
  "color": {
    "grayscale": { // uses dark opacity from surface
      transparent: 0%, superTransparent: 10%, semiTranslucid: 20%,
      translucid: 50%, superTranslucid: 80%, semiOpaque: 90%, opaque: 100%
    },
    "light": { // uses light opacity from surface
      // same structure with light values
    }
  },
  "raw": { // pure numerical values
    transparent: 0, superTransparent: 10, semiTranslucid: 20,
    translucid: 50, superTranslucid: 80, semiOpaque: 90, opaque: 100
  }
}
```

**3. Typography - Complete typographic system:**
```json
"typography": {
  "fontFamilies": { 
    code, content, display, main // 4 families
  },
  "fontWeights": { // complete structure
    [family]: {
      light: { normal, italic },
      regular: { normal, italic },
      semibold: { normal, italic },
      bold: { normal, italic },
      stronger: { normal, italic } // maps to black
    }
  },
  "fontSizes": { // 11 sizes
    micro: 10, extraSmall: 12, small: 14, medium: 16, 
    large: 20, extraLarge: 24, mega: 28, giga: 36, 
    tera: 40, peta: 48, exa: 60
  },
  "lineHeights": { // 4 variations Ã— 11 sizes
    tight: { micro â†’ exa }, // 100%
    close: { micro â†’ exa }, // 120% 
    regular: { micro â†’ exa }, // 140%
    wild: { micro â†’ exa } // 180%
  },
  "letterSpacings": { 
    regular: 0%, tight: -2%, wild: 2% 
  },
  "textDecorations": {
    default: "none", underline: "underline", lineThrough: "line-through"
  },
  "textCases": {
    capitalize: "capitalize"
  }
}
```

**4. Spacing - Spacing system:**
```json
"spacing": {
  "zero": 0, "pico": 1, "nano": 2, "micro": 4,
  "extraSmall": 8, "small": 12, "medium": 16,
  "large": 20, "extraLarge": 24, "mega": 28,
  "giga": 44, "tera": 72, "peta": 116
}
```

**5. Sizing - Size system:**
```json
"sizing": {
  // same structure as spacing
}
```

**6. Border Radius - Border system:**
```json
"borderRadius": {
  "straight": 0, "micro": 2, "extraSmall": 4, "small": 8,
  "medium": 12, "large": 16, "extraLarge": 20, "mega": 24,
  "circular": 9999
}
```

**7. Shadows - Shadow system:**
```json
"shadows": {
  "depth": {
    "level1": { x, y, blur, spread, color },
    "level2": { x, y, blur, spread, color },
    "level3": { x, y, blur, spread, color },
    "level4": { x, y, blur, spread, color }
  }
}
```

### **5. FOUNDATION - Simplified Interface**

- **Responsibility:** Creates simplified interface for direct use in components
- **Files:** `foundation/default.json`, `foundation/styles/`
- **Purpose:** Abstract Semantic complexity for practical use

#### **Foundation Structure:**

**1. Backgrounds (`bg`):**
```json
"foundation": {
  "bg": {
    "primary": "{semantic.color.brand.ambient.contrast.deep.background}",
    "secondary": "{semantic.color.brand.ambient.neutral.lowest.background}",
    "disabled": "{semantic.color.interface.function.disabled.normal.background}",
    "brand": {
      "first": { "lowest": {}, "default": {}, "highest": {} },
      "second": { "lowest": {}, "default": {}, "highest": {} },
      "third": { "lowest": {}, "default": {}, "highest": {} }
    },
    "feedback": {
      "info": { "primary": {}, "secondary": {} },
      "success": { "primary": {}, "secondary": {} },
      "warning": { "primary": {}, "secondary": {} },
      "danger": { "primary": {}, "secondary": {} }
    }
  }
}
```

**2. Borders (`border`):**
```json
"border": {
  "primary": "{semantic.color.brand.ambient.contrast.base.border}",
  "secondary": "{semantic.color.brand.ambient.grayscale.lower.border}",
  "tertiary": "{semantic.color.brand.ambient.grayscale.mid.border}",
  "disabled": "{semantic.color.interface.function.disabled.normal.border}",
  "brand": { /* same structure as bg.brand */ },
  "feedback": { /* same structure as bg.feedback */ }
}
```

**3. Text (`text`):**
```json
"text": {
  "primary": "{semantic.color.text.title}",
  "secondary": "{semantic.color.text.body}",
  "muted": "{semantic.color.text.muted}",
  "disabled": "{semantic.color.interface.function.disabled.normal.txtOn}",
  "brand": { /* same structure as bg.brand */ },
  "feedback": { /* same structure as bg.feedback */ }
}
```

**4. Typography (`typography`):**
```json
"typography": {
  "fontFamilies": { /* direct reference to semantic */ },
  "fontWeights": { /* direct reference to semantic */ },
  "fontSizes": { /* direct reference to semantic */ },
  "lineHeights": { /* direct reference to semantic */ },
  "letterSpacings": { /* direct reference to semantic */ }
}
```

**5. Spacing (`spacing`):**
```json
"spacing": { /* direct reference to semantic */ }
```

**6. Sizing (`sizing`):**
```json
"sizing": { /* direct reference to semantic */ }
```

**7. Border Radius (`borderRadius`):**
```json
"borderRadius": { /* direct reference to semantic */ }
```

**8. Shadows (`shadows`):**
```json
"shadows": { /* direct reference to semantic */ }
```

#### **Foundation Styles:**

**`foundation/styles/typography-styles.json`:**
- Pre-defined typography combinations
- Ex: `heading1`, `body1`, `caption`, etc.

**`foundation/styles/depth-styles.json`:**
- Pre-defined shadow combinations
- Ex: `card`, `modal`, `tooltip`, etc.

---

## ğŸ”§ Tools and Automation

### **Figma Generators**
- **Location:** `figma-generators/_generator-dimension.json`
- **Purpose:** Generate specific tokens for Figma
- **Functionality:** Transforms tokens into Tokens Studio compatible format

### **Metadata and Configuration**
- **`$metadata.json`:** Defines token set loading order
- **`$themes.json`:** Theme configurations in Tokens Studio
- **Token Set Order:** Controls precedence and conflict resolution

---

## ğŸ“ˆ Scalability and Maintenance

### **Adding New Brands:**
1. Create folder `brand/theme/[new-brand]/`
2. Add files `_brand.json`, `_grayscale.json`, etc.
3. Update `$metadata.json` with new order
4. System automatically generates all derived themes

### **Adding New Modes:**
1. Create file `mode/[new-mode].json`
2. Define specific transformations
3. Update `$metadata.json`
4. System propagates to all brands

### **Adding New Surfaces:**
1. Create file `surface/[new-surface].json`
2. Define inversion logic
3. Update `$metadata.json`
4. System applies to all combinations

---

## ğŸ¯ Architecture Benefits

### **1. Exponential Scalability**
- 1 brand Ã— 2 modes Ã— 2 surfaces = 4 automatic themes
- Adding 1 brand automatically generates 4+ themes
- New modes/surfaces multiply possibilities

### **2. Guaranteed Consistency**
- Standardized mathematical transformations
- Visual hierarchy preserved in all contexts
- Accessibility automatically validated

### **3. Simplified Maintenance**
- Changes in 1 file propagate to all themes
- Isolated responsibilities per layer
- Debugging facilitated by clear transformations

### **4. Controlled Flexibility**
- Brands can customize while maintaining structure
- Global component tokens per brand
- Extensible without breaking existing system

---

*This architecture transforms the complexity of multiple themes into an automated, scalable, and reliable process.* 